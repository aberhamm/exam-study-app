services:
  # Next.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: scxmcl-app
    restart: unless-stopped
    ports:
      - '${APP_PORT:-3000}:3000'
    environment:
      # Node environment
      NODE_ENV: production

      # MongoDB connection (external)
      MONGODB_URI: ${MONGODB_URI}
      MONGODB_DB: ${MONGODB_DB:-study-util}

      # OpenAI API (for embeddings) - used when USE_PORTKEY is not enabled
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      QUESTIONS_EMBEDDING_MODEL: ${QUESTIONS_EMBEDDING_MODEL:-text-embedding-3-small}
      QUESTIONS_EMBEDDING_DIMENSIONS: ${QUESTIONS_EMBEDDING_DIMENSIONS:-}

      # OpenRouter API (for AI features) - used when USE_PORTKEY is not enabled
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_MODEL: ${OPENROUTER_MODEL:-anthropic/claude-3.5-sonnet}

      # Portkey (routes all LLM calls through Portkey when enabled)
      USE_PORTKEY: ${USE_PORTKEY:-}
      PORTKEY_API_KEY: ${PORTKEY_API_KEY:-}
      PORTKEY_MODEL: ${PORTKEY_MODEL:-@openai-prod/gpt-4o}

      # Authentication (required for admin features)
      AUTH_SECRET: ${AUTH_SECRET}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}

      # Session Configuration
      SESSION_MAX_AGE: ${SESSION_MAX_AGE:-28800}
      SESSION_UPDATE_AGE: ${SESSION_UPDATE_AGE:-3600}

      # Feature Flags
      DEBUG_RETRIEVAL: ${DEBUG_RETRIEVAL:-}

      # Advanced Configuration
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}
      SITE_URL: ${SITE_URL:-http://localhost:3000}
      CANDIDATE_MULTIPLIER: ${CANDIDATE_MULTIPLIER:-10}
      MAX_CANDIDATES: ${MAX_CANDIDATES:-100}
      MAX_CONTEXT_CHUNKS: ${MAX_CONTEXT_CHUNKS:-4}
      MAX_CHUNK_CHARS: ${MAX_CHUNK_CHARS:-1500}
      API_TIMEOUT_MS: ${API_TIMEOUT_MS:-30000}
      MAX_RETRIES: ${MAX_RETRIES:-3}
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000/api/db-status', (r) => {let d='';r.on('data',c=>d+=c);r.on('end',()=>{try{const j=JSON.parse(d);process.exit(j.connected?0:1)}catch(e){process.exit(1)}}})",
        ]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 40s
    networks:
      - shared-mongo-net

networks:
  shared-mongo-net:
    external: true
